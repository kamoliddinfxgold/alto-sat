<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Reading Test - Improved Design</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="reading_data.js"></script>
    <style>
        /* Modern Card-Based Layout */
        .reading-test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .reading-card {
            background: linear-gradient(145deg, #1a1a1a, #222);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 215, 0, 0.1);
            max-height: 75vh;
            overflow-y: auto;
            position: relative;
        }

        .reading-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #FFD700, #FF8C00, #FFD700);
            border-radius: 20px 20px 0 0;
        }

        .passage-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .passage-header h2 {
            color: #FFD700;
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .passage-meta {
            color: #aaa;
            font-size: 0.9rem;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .highlighter-toggle-btn {
            background: linear-gradient(145deg, #FFD700, #FFA000);
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .highlighter-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .highlighter-toggle-btn:active {
            transform: translateY(0);
        }

        .passage-content {
            line-height: 1.8;
            font-size: 1.15rem;
            color: #f0f0f0;
        }

        .passage-content p {
            margin-bottom: 25px;
            text-align: justify;
            hyphens: auto;
        }

        .highlighted-term {
            background: rgba(255, 215, 0, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #FFD700;
        }

        /* Highlighter styles */
        .highlight-yellow {
            background-color: #FFEB3B;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .highlight-green {
            background-color: #8BC34A;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .highlight-blue {
            background-color: #4FC3F7;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .highlight-pink {
            background-color: #F48FB1;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* Highlighter toolbar */
        .highlighter-toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.95);
            border-radius: 30px;
            padding: 15px;
            display: flex;
            gap: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .highlighter-tool {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .highlighter-tool:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        
        .highlighter-tool.active {
            border-color: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        
        .highlighter-yellow { background-color: #FFEB3B; color: #333; }
        .highlighter-green { background-color: #8BC34A; color: #333; }
        .highlighter-blue { background-color: #4FC3F7; color: #333; }
        .highlighter-pink { background-color: #F48FB1; color: #333; }
        .highlighter-erase { background-color: #f44336; color: white; }
        .highlighter-clear-all { background-color: #607D8B; color: white; }
        
        /* Note highlight style */
        .highlight-note {
            background-color: #9C27B0;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: rgba(255, 255, 255, 0.7);
        }
        
        /* Note popup styles */
        .note-popup {
            position: absolute;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            width: 300px;
            max-width: 90vw;
        }
        
        .note-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
        }
        
        .note-popup-header h3 {
            margin: 0;
            color: #9C27B0;
            font-size: 1.1rem;
        }
        
        .note-popup-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .note-popup-close:hover {
            color: white;
        }
        
        .note-popup textarea {
            width: 100%;
            height: 100px;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
            padding: 10px;
            resize: vertical;
            font-family: inherit;
            font-size: 0.9rem;
        }
        
        .note-popup textarea:focus {
            outline: none;
            border-color: #9C27B0;
        }
        
        .note-popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .note-popup-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .note-popup-save {
            background: #9C27B0;
            color: white;
        }
        
        .note-popup-delete {
            background: #f44336;
            color: white;
        }
        
        .note-popup-cancel {
            background: #555;
            color: white;
        }

        .questions-card {
            background: linear-gradient(145deg, #1a1a1a, #222);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 65, 54, 0.1);
            max-height: 75vh;
            overflow-y: auto;
            position: relative;
        }

        .questions-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #FF4136, #FF851B, #FF4136);
            border-radius: 20px 20px 0 0;
        }

        .questions-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 65, 54, 0.2);
        }

        .questions-header h2 {
            color: #FF4136;
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .question-stats {
            color: #aaa;
            font-size: 0.9rem;
            display: flex;
            gap: 20px;
        }

        /* Enhanced Question Items */
        .question-item {
            background: rgba(30, 30, 30, 0.7);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .question-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .question-item:last-child {
            margin-bottom: 0;
        }

        .question-item.active {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.05);
        }

        .question-text {
            font-size: 1.2rem;
            color: #f0f0f0;
            margin-bottom: 20px;
            line-height: 1.6;
            font-weight: 500;
        }

        .question-number {
            display: inline-block;
            background: #FF4136;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 15px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Enhanced Options */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .option-card {
            background: rgba(40, 40, 40, 0.9);
            border: 2px solid #333;
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            min-height: 70px;
        }

        .option-card:hover {
            background: rgba(50, 50, 50, 0.9);
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateX(5px);
        }

        .option-card.selected {
            background: rgba(46, 204, 64, 0.15);
            border-color: #2ECC40;
            transform: translateX(8px);
        }

        .option-card.incorrect {
            background: rgba(255, 65, 54, 0.15);
            border-color: #FF4136;
        }

        .option-letter {
            background: #444;
            color: #fff;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .option-card.selected .option-letter {
            background: #2ECC40;
            color: white;
        }

        .option-card.incorrect .option-letter {
            background: #FF4136;
            color: white;
        }

        .option-text {
            color: #f0f0f0;
            font-size: 1rem;
            line-height: 1.4;
            flex-grow: 1;
        }

        /* Enhanced Timer */
        .test-timer {
            background: linear-gradient(145deg, #1a1a1a, #222);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border: 2px solid #FF4136;
            text-align: center;
            box-shadow: 0 5px 20px rgba(255, 65, 54, 0.2);
        }

        .timer-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FF4136;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(255, 65, 54, 0.3);
        }

        .timer-label {
            color: #aaa;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Progress Indicator */
        .progress-section {
            background: linear-gradient(145deg, #1a1a1a, #222);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF4136, #FF851B);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        /* Enhanced Navigation Buttons */
        .test-navigation {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .nav-btn {
            padding: 18px;
            font-size: 1.1rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
        }

        .nav-btn i {
            font-size: 1.2rem;
        }

        .nav-btn.new-test {
            background: linear-gradient(145deg, #004466, #006699);
            color: white;
        }

        .nav-btn.save {
            background: linear-gradient(145deg, #006622, #009944);
            color: white;
        }

        .nav-btn.submit {
            background: linear-gradient(145deg, #990000, #CC0000);
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .nav-btn:active {
            transform: translateY(-1px);
        }

        /* Test Actions */
        .test-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 40px;
        }

        .test-actions button {
            padding: 18px;
            font-size: 1.2rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .test-actions .back-btn {
            background: #333;
            color: #FFD700;
            border: 2px solid #FFD700;
        }

        .test-actions .submit-test-btn {
            background: linear-gradient(145deg, #FF4136, #FF851B);
            color: white;
        }

        /* Enhanced Modal Styles */
        .modal {
            display: block;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(145deg, #1a1a1a, #222);
            margin: 3% auto;
            padding: 40px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            width: 85%;
            max-width: 900px;
            position: relative;
            color: #FFD700;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .modal-header h2 {
            font-size: 2.2rem;
            color: #FFD700;
            margin-bottom: 10px;
        }
        
        .modal-header .close {
            color: #aaa;
            position: absolute;
            right: 25px;
            top: 20px;
            font-size: 36px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .modal-header .close:hover {
            color: #FFD700;
        }
        
        .score-card {
            background: rgba(255, 215, 0, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .overall-score {
            font-size: 3rem;
            font-weight: bold;
            color: #FFD700;
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .band-score {
            font-size: 1.5rem;
            color: #2ECC40;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .detailed-results {
            max-height: 400px;
            overflow-y: auto;
            margin: 30px 0;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .reading-test-container {
                grid-template-columns: 1fr;
            }
            
            .reading-card,
            .questions-card {
                max-height: 60vh;
            }
        }

        @media (max-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .test-navigation {
                grid-template-columns: 1fr;
            }
            
            .test-actions {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 25px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #222;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #FFD700, #FF8C00);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #FF8C00, #FFD700);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Improved Reading Test Section -->
        <div id="reading-test" class="container">
            <div class="top-back-button">
                <button onclick="window.location.href='ielts.html'" class="back-btn">
                    ‚Üê Back to IELTS Options
                </button>
            </div>
            <div class="clearfix"></div>
            
            <header>
                <h1 style="font-size: 2.5rem; margin-bottom: 10px;">üìñ IELTS Reading Practice Test</h1>
                <p style="color: #aaa; font-size: 1.1rem;">Academic Reading | Time: 60 minutes | Questions: 32</p>
            </header>
            
            <!-- Progress Section -->
            <div class="progress-section">
                <div class="progress-info">
                    <span id="progress-text">Progress: 0/8 questions answered</span>
                    <span id="time-remaining">Time Remaining: 60:00</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div class="reading-test-container">
                <!-- Passage Card -->
                <div class="reading-card">
                    <div class="passage-header">
                        <h2 id="passage-title">Urbanization Trends Around the World</h2>
                        <div class="passage-meta">
                            <span>üìÑ Passage Length: 450 words</span>
                            <span>üéØ Difficulty: Medium</span>
                            <span>‚è±Ô∏è Suggested Time: 20 minutes</span>
                            <button class="highlighter-toggle-btn" onclick="toggleHighlighterToolbar()" title="Toggle Highlighter (Ctrl+H)">
                                ‚úèÔ∏è Highlighter
                            </button>
                            <button class="highlighter-toggle-btn" onclick="toggleNotesSidebar()" title="View Notes" style="margin-left: 10px;">
                                üìù Notes
                            </button>
                        </div>
                    </div>
                    <div class="passage-content" id="passage-content">
                        <p><span class="highlighted-term">Urbanization</span>, the process by which rural communities become urban, has been one of the most significant demographic trends of the past century. As economies develop and industrialize, people migrate from rural areas to cities in search of better employment opportunities, education, and healthcare.</p>
                        <p>In the early 20th century, less than 30% of the world's population lived in urban areas. However, by 2010, this figure had risen to over 50%, representing a dramatic shift in human settlement patterns. This trend is particularly pronounced in developing nations, where urban growth rates often exceed 3% annually.</p>
                        <p>The rapid pace of urbanization presents both opportunities and challenges. Cities are engines of economic growth, generating disproportionate shares of national GDP and fostering innovation. They concentrate human capital and facilitate the exchange of ideas. However, rapid urban growth can also strain infrastructure and services, leading to the proliferation of informal settlements and slums.</p>
                        <p>Environmental concerns are another critical aspect of urbanization. While cities are often more energy-efficient per capita than rural areas, their sheer size means they consume vast quantities of resources and generate significant pollution. Urban planners and policymakers must balance the need for economic development with environmental sustainability.</p>
                        <p>Looking ahead, the United Nations projects that by 2050, nearly 70% of the global population will reside in urban areas. Managing this transition effectively will be crucial for sustainable development. This requires forward-thinking policies that address housing, transportation, water supply, sanitation, and employment generation.</p>
                    </div>
                </div>
                
                <!-- Questions Card -->
                <div class="questions-card">
                    <div class="questions-header">
                        <h2>Questions</h2>
                        <div class="question-stats">
                            <span>üìù Multiple Choice</span>
                            <span>‚úÖ 0/8 Completed</span>
                            <span>üéØ Score: 0/40</span>
                        </div>
                    </div>
                    
                    <div id="questions-container">
                        <!-- Questions will be dynamically loaded here -->
                        <div class="question-item active" data-question="1">
                            <div class="question-text">
                                <span class="question-number">1</span>
                                According to the passage, what percentage of the world's population lived in urban areas by 2010?
                            </div>
                            <div class="options-grid">
                                <div class="option-card" data-question="1" data-answer="a">
                                    <div class="option-letter">A</div>
                                    <div class="option-text">Less than 30%</div>
                                </div>
                                <div class="option-card" data-question="1" data-answer="b">
                                    <div class="option-letter">B</div>
                                    <div class="option-text">Over 50%</div>
                                </div>
                                <div class="option-card" data-question="1" data-answer="c">
                                    <div class="option-letter">C</div>
                                    <div class="option-text">Nearly 70%</div>
                                </div>
                                <div class="option-card" data-question="1" data-answer="d">
                                    <div class="option-letter">D</div>
                                    <div class="option-text">Exactly 40%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="question-item" data-question="2">
                            <div class="question-text">
                                <span class="question-number">2</span>
                                What is identified as a challenge of rapid urbanization?
                            </div>
                            <div class="options-grid">
                                <div class="option-card" data-question="2" data-answer="a">
                                    <div class="option-letter">A</div>
                                    <div class="option-text">Lack of innovation</div>
                                </div>
                                <div class="option-card" data-question="2" data-answer="b">
                                    <div class="option-letter">B</div>
                                    <div class="option-text">Decreased economic growth</div>
                                </div>
                                <div class="option-card" data-question="2" data-answer="c">
                                    <div class="option-letter">C</div>
                                    <div class="option-text">Strain on infrastructure</div>
                                </div>
                                <div class="option-card" data-question="2" data-answer="d">
                                    <div class="option-letter">D</div>
                                    <div class="option-text">Reduced migration</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- More questions will be added dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Timer -->
            <div class="test-timer">
                <div class="timer-label">Time Remaining</div>
                <div class="timer-display" id="reading-timer">59:59</div>
                <div style="color: #aaa; margin-top: 10px;">
                    ‚ö†Ô∏è Test will auto-submit when time expires
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="test-navigation">
                <button class="nav-btn new-test" id="new-reading-test">
                    üîÑ Get New Test
                </button>
                <button class="nav-btn save" id="save-answers">
                    üíæ Save Progress
                </button>
                <button class="nav-btn submit" id="submit-reading-answers">
                    üì§ Submit Test
                </button>
            </div>
            
            <!-- Main Test Actions -->
            <div class="test-actions">
                <button onclick="window.location.href='ielts.html'" class="back-btn">
                    ‚Üê Back to IELTS Options
                </button>
                <button id="submit-reading-test" class="submit-test-btn">
                    üéØ Final Submit
                </button>
            </div>
            
            <!-- Highlighter Toolbar -->
            <div class="highlighter-toolbar" id="highlighter-toolbar" style="display: none;">
                <div class="highlighter-tool highlighter-yellow" data-color="yellow" title="Yellow Highlight">
                    <i>‚úèÔ∏è</i>
                </div>
                <div class="highlighter-tool highlighter-green" data-color="green" title="Green Highlight">
                    <i>‚úèÔ∏è</i>
                </div>
                <div class="highlighter-tool highlighter-blue" data-color="blue" title="Blue Highlight">
                    <i>‚úèÔ∏è</i>
                </div>
                <div class="highlighter-tool highlighter-pink" data-color="pink" title="Pink Highlight">
                    <i>‚úèÔ∏è</i>
                </div>
                <div class="highlighter-tool highlighter-erase" data-color="erase" title="Erase Highlight">
                    <i>üßπ</i>
                </div>
                <div class="highlighter-tool highlighter-clear-all" data-color="clear-all" title="Clear All Highlights">
                    <i>üóëÔ∏è</i>
                </div>
                <div class="highlighter-tool" data-color="note" title="Add Note" style="background-color: #9C27B0; color: white;">
                    <i>üìù</i>
                </div>
            </div>
            
            <!-- Notes Sidebar -->
            <div class="notes-sidebar" id="notes-sidebar" style="position: fixed; right: -350px; top: 0; width: 350px; height: 100vh; background: #2a2a2a; border-left: 1px solid #444; z-index: 1500; transition: right 0.3s ease; box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);">
                <div style="height: 100%; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid #444; background: #333;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; color: #9C27B0;">üìù Notes</h2>
                            <button id="close-notes-sidebar" style="background: none; border: none; color: #aaa; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                    </div>
                    <div id="notes-list" style="flex: 1; overflow-y: auto; padding: 20px;">
                        <p style="color: #aaa; text-align: center;">No notes yet. Add notes using the note tool.</p>
                    </div>
                    <div style="padding: 15px; border-top: 1px solid #444; background: #333; text-align: center;">
                        <button id="clear-all-notes" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600;">Clear All Notes</button>
                    </div>
                </div>
            </div>

            <!-- Enhanced Results Modal -->
            <div id="reading-results-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üéâ Reading Test Results</h2>
                        <span class="close" id="close-reading-results">&times;</span>
                    </div>
                    
                    <div id="reading-results-content">
                        <div class="score-card">
                            <h3 style="text-align: center; margin-bottom: 10px;">Performance Summary</h3>
                            <div class="overall-score" id="overall-score">0/40</div>
                            <div class="band-score" id="ielts-band">IELTS Band: N/A</div>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; color: #2ECC40;" id="correct-answers">0</div>
                                    <div style="color: #aaa;">Correct Answers</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; color: #FF4136;" id="incorrect-answers">0</div>
                                    <div style="color: #aaa;">Incorrect Answers</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; color: #FFD700;" id="percentage-score">0%</div>
                                    <div style="color: #aaa;">Accuracy Rate</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detailed-results" id="detailed-results">
                            <!-- Detailed results will be loaded here -->
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button id="close-results-btn" style="padding: 15px 40px; font-size: 1.2rem;">
                                Close Results
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ufmoftsasbwfeqerilpq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmbW9mdHNhc2J3ZmVxZXJpbHBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzY3NjksImV4cCI6MjA4MDQxMjc2OX0.qGp-15_VWEPaK0vaCbmT2bIL0xd0Ntchh-ahvKiOOLw';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Extended questions data (8 questions per passage)
        const extendedQuestions = {
            "Urbanization Trends Around the World": [
                {
                    id: 1,
                    text: "According to the passage, what percentage of the world's population lived in urban areas by 2010?",
                    options: ["Less than 30%", "Over 50%", "Nearly 70%", "Exactly 40%"],
                    correct: 1
                },
                {
                    id: 2,
                    text: "What is identified as a challenge of rapid urbanization?",
                    options: ["Lack of innovation", "Decreased economic growth", "Strain on infrastructure", "Reduced migration"],
                    correct: 2
                },
                {
                    id: 3,
                    text: "According to the passage, what is one advantage of cities mentioned in the text?",
                    options: ["Lower pollution levels", "Engines of economic growth", "Reduced population density", "Better rural development"],
                    correct: 1
                },
                {
                    id: 4,
                    text: "What does the passage suggest about future urbanization trends?",
                    options: ["Urbanization will slow down significantly", "Rural populations will increase", "70% of the global population will be urban by 2050", "Developing nations will stop urbanizing"],
                    correct: 2
                },
                {
                    id: 5,
                    text: "In which century did urbanization become a significant demographic trend?",
                    options: ["18th century", "19th century", "20th century", "21st century"],
                    correct: 2
                },
                {
                    id: 6,
                    text: "What annual urban growth rate is mentioned for developing nations?",
                    options: ["1%", "2%", "3%", "5%"],
                    correct: 2
                },
                {
                    id: 7,
                    text: "What are cities described as in terms of economic growth?",
                    options: ["Obstacles", "Engines", "Regulators", "Consumers"],
                    correct: 1
                },
                {
                    id: 8,
                    text: "What must urban planners balance according to the passage?",
                    options: ["Population and resources", "Economic development and environmental sustainability", "Urban and rural needs", "Public and private sectors"],
                    correct: 1
                }
            ],
            "The Impact of Technology on Education": [
                {
                    id: 1,
                    text: "What is one significant advantage of educational technology mentioned in the passage?",
                    options: ["Reduces teacher workload", "Eliminates the need for classrooms", "Personalizes learning experiences", "Makes education free for everyone"],
                    correct: 2
                },
                {
                    id: 2,
                    text: "According to the passage, what limitation of traditional classroom instruction does technology address?",
                    options: ["Lack of textbooks", "Inability to assign homework", "Catering to the average student", "Short class periods"],
                    correct: 2
                },
                {
                    id: 3,
                    text: "How has technology expanded access to education?",
                    options: ["By reducing tuition costs", "Through online courses and digital resources", "By building more schools", "By hiring more teachers"],
                    correct: 1
                },
                {
                    id: 4,
                    text: "What challenge related to educational technology is mentioned in the passage?",
                    options: ["Students prefer traditional books", "Teachers enjoy using technology too much", "The digital divide", "Technology is too expensive"],
                    correct: 2
                },
                {
                    id: 5,
                    text: "What type of learning systems can adjust difficulty based on student performance?",
                    options: ["Adaptive learning systems", "Traditional systems", "Manual systems", "Basic systems"],
                    correct: 0
                },
                {
                    id: 6,
                    text: "Who benefits particularly from the democratization of education through technology?",
                    options: ["Only children", "Remote communities and adult learners", "University students only", "Government officials"],
                    correct: 1
                },
                {
                    id: 7,
                    text: "What emerging technologies are mentioned as promising to revolutionize education?",
                    options: ["Artificial intelligence and virtual reality", "Robots and drones", "Blockchain and cryptocurrency", "3D printing and nanotechnology"],
                    correct: 0
                },
                {
                    id: 8,
                    text: "What do educators need for effective technology integration?",
                    options: ["More funding", "Comprehensive professional development", "Smaller classes", "Better students"],
                    correct: 1
                }
            ],
            "Climate Change and Its Global Impacts": [
                {
                    id: 1,
                    text: "What is identified as a major contributor to climate change according to the passage?",
                    options: ["Volcanic eruptions", "Solar radiation cycles", "Burning of fossil fuels", "Natural forest fires"],
                    correct: 2
                },
                {
                    id: 2,
                    text: "Which of the following is mentioned as an effect of climate change?",
                    options: ["Increased polar bear populations", "More frequent extreme weather events", "Expansion of desert regions", "Improved crop yields"],
                    correct: 1
                },
                {
                    id: 3,
                    text: "What economic sector is specifically mentioned as facing uncertainty due to climate change?",
                    options: ["Banking industry", "Agricultural sector", "Entertainment industry", "Construction sector"],
                    correct: 1
                },
                {
                    id: 4,
                    text: "What international agreement is mentioned in the passage?",
                    options: ["Kyoto Protocol", "Montreal Protocol", "Paris Agreement", "Rio Declaration"],
                    correct: 2
                },
                {
                    id: 5,
                    text: "What is one environmental consequence of cities mentioned in the passage?",
                    options: ["Reduced energy consumption", "Generation of significant pollution", "Improved air quality", "Decreased resource consumption"],
                    correct: 1
                },
                {
                    id: 6,
                    text: "What is one solution mentioned for mitigating climate change impacts?",
                    options: ["Increasing fossil fuel usage", "Innovation in renewable energy technologies", "Reducing international cooperation", "Eliminating electric vehicles"],
                    correct: 1
                },
                {
                    id: 7,
                    text: "What challenge do tourism industries face due to climate change?",
                    options: ["Increased visitor numbers", "Uncertain futures in vulnerable areas", "Higher profits", "Expanded operations"],
                    correct: 1
                },
                {
                    id: 8,
                    text: "What level of global warming do countries aim to limit according to the Paris Agreement?",
                    options: ["1 degree Celsius above pre-industrial levels", "2 degrees Celsius above pre-industrial levels", "3 degrees Celsius above pre-industrial levels", "No specific limit mentioned"],
                    correct: 1
                }
            ],
            "The Evolution of Social Media Platforms": [
                {
                    id: 1,
                    text: "Which platform is credited with revolutionizing social media by emphasizing real identities?",
                    options: ["MySpace", "Six Degrees", "Facebook", "Twitter"],
                    correct: 2
                },
                {
                    id: 2,
                    text: "What type of content platforms are Instagram and TikTok primarily focused on?",
                    options: ["Audio podcasts", "Text-based blogs", "Image and video-based communication", "Professional networking"],
                    correct: 2
                },
                {
                    id: 3,
                    text: "What concern has been raised about the addictive nature of social media platforms?",
                    options: ["Increased productivity", "Mental health issues", "Improved sleep patterns", "Enhanced face-to-face communication"],
                    correct: 1
                },
                {
                    id: 4,
                    text: "What concept represents the future vision of immersive digital social environments?",
                    options: ["Digital detox", "Virtual private networks", "The metaverse", "Cloud computing"],
                    correct: 2
                },
                {
                    id: 5,
                    text: "What feature of social media platforms creates echo chambers according to the passage?",
                    options: ["Privacy settings", "Sophisticated algorithms", "Comment sections", "Share buttons"],
                    correct: 1
                },
                {
                    id: 6,
                    text: "What major challenge has emerged for social media companies regarding content?",
                    options: ["Generating enough content", "Misinformation and data breaches", "Limited user engagement", "Slow loading speeds"],
                    correct: 1
                },
                {
                    id: 7,
                    text: "What time period saw the emergence of Friendster and MySpace?",
                    options: ["Late 1990s", "Early 2000s", "Late 2000s", "Early 2010s"],
                    correct: 1
                },
                {
                    id: 8,
                    text: "What is required for the success of immersive digital world initiatives?",
                    options: ["Government regulation", "Overcoming technical limitations and user adoption barriers", "Reducing platform features", "Eliminating virtual environments"],
                    correct: 1
                }
            ]
        };
        
        // User answers storage
        let userAnswers = {};
        let currentTestData = null;
        let totalQuestions = 0;
        
        // Timer functionality
        let totalSeconds = 60 * 60; // 60 minutes
        const timerElement = document.getElementById('reading-timer');
        const timeRemainingElement = document.getElementById('time-remaining');
        
        // Check user session when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await checkUserSession();
            initReadingTest();
            
            // Update progress bar
            updateProgress();
        });
        
        // Check if user is authenticated but don't redirect to login
        async function checkUserSession() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    // Don't redirect to login page - let the main dashboard handle this
                    console.log('No active session, but continuing to allow navigation');
                }
            } catch (error) {
                console.error('Error checking session:', error);
                // Don't redirect on error - let the main dashboard handle this
                console.log('Session check error, but continuing to allow navigation');
            }
        }
        
        // Initialize the reading test
        function initReadingTest() {
            loadRandomTest();
            
            // Add event listeners
            document.getElementById('new-reading-test').addEventListener('click', loadRandomTest);
            document.getElementById('save-answers').addEventListener('click', saveAnswers);
            document.getElementById('submit-reading-answers').addEventListener('click', submitAnswers);
            document.getElementById('close-reading-results').addEventListener('click', closeResults);
            document.getElementById('close-results-btn').addEventListener('click', closeResults);
            document.getElementById('submit-reading-test').addEventListener('click', submitAnswers);
            
            // Initialize question navigation
            initQuestionNavigation();
        }
        
        // Initialize question navigation and selection
        function initQuestionNavigation() {
            // Add click handlers to option cards
            document.addEventListener('click', function(e) {
                const optionCard = e.target.closest('.option-card');
                if (optionCard) {
                    const questionNum = optionCard.getAttribute('data-question');
                    const answer = optionCard.getAttribute('data-answer');
                    userAnswers[questionNum] = answer;
                    
                    // Update UI
                    updateSelectedOption(questionNum, answer);
                    updateProgress();
                }
                
                // Question item click for navigation
                const questionItem = e.target.closest('.question-item');
                if (questionItem) {
                    const questionNum = questionItem.getAttribute('data-question');
                    scrollToQuestion(questionNum);
                }
            });
        }
        
        // Update selected option UI
        function updateSelectedOption(questionNum, answer) {
            // Remove selected class from all options for this question
            const questionElement = document.querySelector(`.question-item[data-question="${questionNum}"]`);
            questionElement.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            const selectedCard = questionElement.querySelector(`.option-card[data-answer="${answer}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // Mark question as answered
            questionElement.classList.add('answered');
        }
        
        // Load a random reading test
        function loadRandomTest() {
            const randomIndex = Math.floor(Math.random() * ieltsReadingTests.length);
            currentTestData = ieltsReadingTests[randomIndex];
            
            // Get extended questions for this passage
            const passageTitle = currentTestData.title;
            const questions = extendedQuestions[passageTitle] || currentTestData.questions;
            totalQuestions = questions.length;
            
            // Update passage
            document.getElementById('passage-title').textContent = passageTitle;
            document.getElementById('passage-content').innerHTML = currentTestData.passage;
            
            // Update questions
            const questionsContainer = document.getElementById('questions-container');
            questionsContainer.innerHTML = '';
            
            questions.forEach((q, index) => {
                const questionNum = index + 1;
                const questionDiv = document.createElement('div');
                questionDiv.className = `question-item ${questionNum === 1 ? 'active' : ''}`;
                questionDiv.setAttribute('data-question', questionNum);
                questionDiv.innerHTML = `
                    <div class="question-text">
                        <span class="question-number">${questionNum}</span>
                        ${q.text}
                    </div>
                    <div class="options-grid">
                        ${q.options.map((option, optIndex) => {
                            const letters = ['a', 'b', 'c', 'd'];
                            const letter = letters[optIndex];
                            return `
                                <div class="option-card" data-question="${questionNum}" data-answer="${letter}">
                                    <div class="option-letter">${letter.toUpperCase()}</div>
                                    <div class="option-text">${option}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionDiv);
            });
            
            // Update progress info
            document.querySelector('.question-stats').innerHTML = `
                <span>üìù Multiple Choice</span>
                <span>‚úÖ 0/${totalQuestions} Completed</span>
                <span>üéØ Score: 0/${totalQuestions * 5}</span>
            `;
            
            // Reset user answers
            userAnswers = {};
            updateProgress();
        }
        
        // Scroll to specific question
        function scrollToQuestion(questionNum) {
            const questionElement = document.querySelector(`.question-item[data-question="${questionNum}"]`);
            if (questionElement) {
                questionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Highlight active question
                document.querySelectorAll('.question-item').forEach(item => {
                    item.classList.remove('active');
                });
                questionElement.classList.add('active');
            }
        }
        
        // Update progress bar and stats
        function updateProgress() {
            const answeredCount = Object.keys(userAnswers).length;
            const progressPercentage = (answeredCount / totalQuestions) * 100;
            
            // Update progress bar
            document.getElementById('progress-fill').style.width = `${progressPercentage}%`;
            document.getElementById('progress-text').textContent = `Progress: ${answeredCount}/${totalQuestions} questions answered`;
            
            // Update question stats
            document.querySelector('.question-stats').innerHTML = `
                <span>üìù Multiple Choice</span>
                <span>‚úÖ ${answeredCount}/${totalQuestions} Completed</span>
                <span>üéØ Score: ${calculateCurrentScore()}/${totalQuestions * 5}</span>
            `;
        }
        
        // Calculate current score
        function calculateCurrentScore() {
            if (!currentTestData) return 0;
            
            const passageTitle = currentTestData.title;
            const questions = extendedQuestions[passageTitle] || currentTestData.questions;
            let score = 0;
            
            questions.forEach((q, index) => {
                const questionNum = index + 1;
                if (userAnswers[questionNum]) {
                    const letters = ['a', 'b', 'c', 'd'];
                    if (userAnswers[questionNum] === letters[q.correct]) {
                        score += 5; // Each question worth 5 points
                    }
                }
            });
            
            return score;
        }
        
        // Save answers
        function saveAnswers() {
            const answeredCount = Object.keys(userAnswers).length;
            const saveTime = new Date().toLocaleTimeString();
            
            // Show success message
            const saveBtn = document.getElementById('save-answers');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '‚úÖ Saved!';
            saveBtn.style.background = 'linear-gradient(145deg, #006622, #009944)';
            
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.style.background = 'linear-gradient(145deg, #006622, #009944)';
            }, 2000);
            
            console.log(`Saved ${answeredCount} answers at ${saveTime}`);
        }
        
        // Submit answers and show results
        function submitAnswers() {
            const answeredCount = Object.keys(userAnswers).length;
            if (answeredCount < totalQuestions) {
                if (!confirm(`You have answered ${answeredCount} out of ${totalQuestions} questions. Do you want to submit anyway?`)) {
                    return;
                }
            }
            
            const passageTitle = currentTestData.title;
            const questions = extendedQuestions[passageTitle] || currentTestData.questions;
            let correctCount = 0;
            const letters = ['a', 'b', 'c', 'd'];
            
            // Calculate score
            questions.forEach((q, index) => {
                const questionNum = index + 1;
                if (userAnswers[questionNum] === letters[q.correct]) {
                    correctCount++;
                }
            });
            
            // Calculate statistics
            const percentage = Math.round((correctCount / totalQuestions) * 100);
            const ieltsBand = calculateIeltsBand(percentage);
            const totalScore = correctCount * 5;
            
            // Display results
            document.getElementById('correct-answers').textContent = correctCount;
            document.getElementById('incorrect-answers').textContent = totalQuestions - correctCount;
            document.getElementById('percentage-score').textContent = `${percentage}%`;
            document.getElementById('overall-score').textContent = `${totalScore}/${totalQuestions * 5}`;
            document.getElementById('ielts-band').textContent = `IELTS Band: ${ieltsBand}`;
            
            // Show detailed results
            const detailedResults = document.getElementById('detailed-results');
            detailedResults.innerHTML = '<h3 style="margin-bottom: 20px;">üìã Question-by-Question Results:</h3>';
            
            questions.forEach((q, index) => {
                const questionNum = index + 1;
                const userAnswer = userAnswers[questionNum] || 'Not answered';
                const correctAnswer = letters[q.correct];
                const isCorrect = userAnswer === correctAnswer;
                const optionText = q.options[correctAnswer.charCodeAt(0) - 97] || '';
                
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${isCorrect ? 'correct' : 'incorrect'}`;
                resultItem.style.padding = '20px';
                resultItem.style.margin = '15px 0';
                resultItem.style.borderRadius = '10px';
                resultItem.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div style="background: ${isCorrect ? '#2ECC40' : '#FF4136'}; 
                                    color: white; 
                                    width: 30px; 
                                    height: 30px; 
                                    border-radius: 50%; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;
                                    margin-right: 15px;
                                    font-weight: bold;">
                            ${isCorrect ? '‚úì' : '‚úó'}
                        </div>
                        <strong style="font-size: 1.1rem;">Question ${questionNum}: ${isCorrect ? 'Correct' : 'Incorrect'}</strong>
                    </div>
                    <div style="margin-left: 45px;">
                        <p><strong>Your answer:</strong> ${userAnswer.toUpperCase()} ${!isCorrect && userAnswer !== 'Not answered' ? 
                            `("${q.options[userAnswer.charCodeAt(0) - 97]}")` : ''}</p>
                        ${!isCorrect ? `
                            <p><strong>Correct answer:</strong> ${correctAnswer.toUpperCase()} ("${optionText}")</p>
                        ` : ''}
                    </div>
                `;
                detailedResults.appendChild(resultItem);
            });
            
            // Show results modal
            document.getElementById('reading-results-modal').classList.remove('hidden');
        }
        
        // Calculate estimated IELTS band score
        function calculateIeltsBand(percentage) {
            if (percentage >= 90) return '9.0';
            if (percentage >= 80) return '8.0 - 8.5';
            if (percentage >= 70) return '7.0 - 7.5';
            if (percentage >= 60) return '6.0 - 6.5';
            if (percentage >= 50) return '5.0 - 5.5';
            if (percentage >= 40) return '4.0 - 4.5';
            return '3.0 or below';
        }
        
        // Close results modal
        function closeResults() {
            document.getElementById('reading-results-modal').classList.add('hidden');
        }
        
        // Timer functions
        function updateTimer() {
            if (totalSeconds <= 0) {
                timerElement.textContent = "00:00";
                timeRemainingElement.textContent = "Time's up!";
                alert("Time's up! The test will be submitted automatically.");
                submitAnswers();
                return;
            }
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timeRemainingElement.textContent = `Time Remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            totalSeconds--;
        }
        
        // Update timer every second
        setInterval(updateTimer, 1000);
        updateTimer();
        
        // Highlighter functionality
        let currentHighlightColor = null;
        let isHighlightingEnabled = false;
        let isNotesSidebarOpen = false;
        
        // Show/hide highlighter toolbar
        function toggleHighlighterToolbar() {
            const toolbar = document.getElementById('highlighter-toolbar');
            isHighlightingEnabled = !isHighlightingEnabled;
            toolbar.style.display = isHighlightingEnabled ? 'flex' : 'none';
            
            // Add visual indication to reading card
            const readingCard = document.querySelector('.reading-card');
            if (isHighlightingEnabled) {
                readingCard.style.boxShadow = '0 0 0 3px #FFD700';
            } else {
                readingCard.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.5)';
                deactivateAllTools();
            }
        }
        
        // Toggle notes sidebar
        function toggleNotesSidebar() {
            const sidebar = document.getElementById('notes-sidebar');
            isNotesSidebarOpen = !isNotesSidebarOpen;
            sidebar.style.right = isNotesSidebarOpen ? '0px' : '-350px';
            
            // Refresh notes list when opening
            if (isNotesSidebarOpen) {
                setTimeout(refreshNotesList, 300);
            }
        }
        
        // Set current highlight color
        function setHighlightColor(color) {
            if (color === 'clear-all') {
                clearAllHighlights();
                return;
            }
            
            if (color === 'note') {
                // Activate note mode
                currentHighlightColor = 'note';
                activateTool('note');
                showHighlightNotification('Select text to add a note');
                return;
            }
            
            currentHighlightColor = color;
            activateTool(color);
        }
        
        // Clear all highlights from the passage
        function clearAllHighlights() {
            const passageContent = document.getElementById('passage-content');
            const highlightedElements = passageContent.querySelectorAll('[class*="highlight-"]');
            
            // Check if there are any highlights to clear
            if (highlightedElements.length === 0) {
                showHighlightNotification('No highlights to clear!');
                return;
            }
            
            // Convert NodeList to array to avoid issues while modifying DOM
            const elementsArray = Array.from(highlightedElements);
            
            elementsArray.forEach(element => {
                // Replace the highlighted span with its text content
                const textNode = document.createTextNode(element.textContent);
                element.parentNode.replaceChild(textNode, element);
            });
            
            // Save the cleared state
            saveHighlights();
            
            // Show notification
            showHighlightNotification(`Cleared ${elementsArray.length} highlights!`);
            
            // Hide toolbar
            toggleHighlighterToolbar();
        }
        
        // Clear all notes
        function clearAllNotes() {
            const passageContent = document.getElementById('passage-content');
            const noteElements = passageContent.querySelectorAll('.highlight-note');
            
            if (noteElements.length === 0) {
                showHighlightNotification('No notes to clear!');
                return;
            }
            
            noteElements.forEach(noteElement => {
                const textNode = document.createTextNode(noteElement.textContent);
                noteElement.parentNode.replaceChild(textNode, noteElement);
            });
            
            showHighlightNotification(`Cleared ${noteElements.length} notes!`);
            saveHighlights();
            setTimeout(refreshNotesList, 100);
        }
        
        // Activate tool visually
        function activateTool(color) {
            // Deactivate all tools
            deactivateAllTools();
            
            // Activate selected tool
            const tool = document.querySelector(`.highlighter-tool[data-color="${color}"]`);
            if (tool) {
                tool.classList.add('active');
            }
        }
        
        // Deactivate all tools
        function deactivateAllTools() {
            document.querySelectorAll('.highlighter-tool').forEach(tool => {
                tool.classList.remove('active');
            });
        }
        
        // Apply highlight to selected text
        function applyHighlight(color) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString().trim() !== '') {
                const range = selection.getRangeAt(0);
                const selectedText = selection.toString();
                
                // Check if selection is within the passage content
                const passageContent = document.getElementById('passage-content');
                if (!passageContent.contains(range.commonAncestorContainer)) {
                    return;
                }
                
                // Handle note functionality
                if (color === 'note') {
                    createNote(range, selectedText);
                    return;
                }
                
                // Handle erase functionality
                if (color === 'erase') {
                    // Remove highlights from selected text
                    removeHighlightsInRange(range);
                    showHighlightNotification('Highlight removed!');
                    return;
                }
                
                // Check if we're selecting already highlighted text
                const ancestor = range.commonAncestorContainer;
                if (ancestor.nodeType === Node.ELEMENT_NODE && ancestor.className && ancestor.className.includes('highlight-')) {
                    // Already highlighted - change color instead
                    ancestor.className = `highlight-${color}`;
                    window.getSelection().removeAllRanges();
                    showHighlightNotification('Highlight color changed!');
                    return;
                }
                
                // Create highlight element
                const highlightSpan = document.createElement('span');
                highlightSpan.className = `highlight-${color}`;
                highlightSpan.textContent = selectedText;
                
                // Delete the content and insert the highlighted element
                range.deleteContents();
                range.insertNode(highlightSpan);
                
                // Clear selection
                window.getSelection().removeAllRanges();
                
                // Show notification
                showHighlightNotification('Text highlighted!');
            }
        }
        
        // Create a note for selected text
        function createNote(range, selectedText) {
            // Create note element
            const noteSpan = document.createElement('span');
            noteSpan.className = 'highlight-note';
            noteSpan.textContent = selectedText;
            noteSpan.dataset.noteId = 'note_' + Date.now(); // Unique ID for the note
            
            // Delete the content and insert the note element
            range.deleteContents();
            range.insertNode(noteSpan);
            
            // Clear selection
            window.getSelection().removeAllRanges();
            
            // Show note popup for editing
            showNotePopup(noteSpan, '');
        }

        // Show temporary notification when text is highlighted
        function showHighlightNotification(message) {
            // Remove any existing notifications
            const existingNotification = document.getElementById('highlight-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.id = 'highlight-notification';
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.bottom = '90px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = 'rgba(30, 30, 30, 0.9)';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '20px';
            notification.style.zIndex = '1001';
            notification.style.fontWeight = 'bold';
            notification.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.3)';
            
            // Add to document
            document.body.appendChild(notification);
            
            // Remove after 2 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 2000);
        }
        
        // Refresh notes list in sidebar
        function refreshNotesList() {
            const notesList = document.getElementById('notes-list');
            const passageContent = document.getElementById('passage-content');
            const noteElements = passageContent.querySelectorAll('.highlight-note[data-note]');
            
            if (noteElements.length === 0) {
                notesList.innerHTML = '<p style="color: #aaa; text-align: center;">No notes yet. Add notes using the note tool.</p>';
                return;
            }
            
            let notesHTML = '';
            noteElements.forEach((noteElement, index) => {
                const noteText = noteElement.dataset.note ? decodeURIComponent(noteElement.dataset.note) : '';
                const notePreview = noteText.length > 100 ? noteText.substring(0, 100) + '...' : noteText;
                
                notesHTML += `
                    <div style="background: #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 3px solid #9C27B0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <strong style="color: #9C27B0;">Note ${index + 1}</strong>
                            <button class="delete-note-btn" data-note-id="${noteElement.dataset.noteId}" style="background: none; border: none; color: #f44336; cursor: pointer; font-size: 1.2rem;">&times;</button>
                        </div>
                        <p style="color: #f0f0f0; margin: 0; white-space: pre-wrap;">${notePreview}</p>
                        <div style="margin-top: 10px;">
                            <button class="view-note-btn" data-note-id="${noteElement.dataset.noteId}" style="background: #9C27B0; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">View Full Note</button>
                        </div>
                    </div>
                `;
            });
            
            notesList.innerHTML = notesHTML;
            
            // Add event listeners to view/delete buttons
            document.querySelectorAll('.view-note-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const noteId = this.getAttribute('data-note-id');
                    const noteElement = document.querySelector(`.highlight-note[data-note-id="${noteId}"]`);
                    if (noteElement) {
                        const noteText = noteElement.dataset.note ? decodeURIComponent(noteElement.dataset.note) : '';
                        showFullNote(noteText);
                    }
                });
            });
            
            document.querySelectorAll('.delete-note-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const noteId = this.getAttribute('data-note-id');
                    const noteElement = document.querySelector(`.highlight-note[data-note-id="${noteId}"]`);
                    if (noteElement) {
                        // Convert note back to regular text
                        const textNode = document.createTextNode(noteElement.textContent);
                        noteElement.parentNode.replaceChild(textNode, noteElement);
                        showHighlightNotification('Note deleted');
                        saveHighlights();
                        setTimeout(refreshNotesList, 100);
                    }
                });
            });
        }

        // Remove highlights from a range
        function removeHighlightsInRange(range) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const selectedRange = selection.getRangeAt(0);
                const selectedContent = selectedRange.cloneContents();
                
                // Get all highlighted elements within the selection
                const highlightedSpans = [];
                for (let i = 0; i < selectedContent.childNodes.length; i++) {
                    const node = selectedContent.childNodes[i];
                    if (node.nodeType === Node.ELEMENT_NODE && node.className && node.className.includes('highlight-')) {
                        highlightedSpans.push(node);
                    }
                }
                
                // For a simpler implementation, we'll just clear the selection
                // A production implementation would need to more carefully 
                // unwrap or remove the highlighted elements
                selection.removeAllRanges();
            }
        }

        // Improved function to remove highlights
        function removeHighlight(spanElement) {
            const parent = spanElement.parentNode;
            while (spanElement.firstChild) {
                parent.insertBefore(spanElement.firstChild, spanElement);
            }
            parent.removeChild(spanElement);
        }
        
        // Show full note in popup
        function showFullNote(noteText) {
            // Remove any existing note popups
            const existingPopup = document.querySelector('.note-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // Create popup element
            const popup = document.createElement('div');
            popup.className = 'note-popup';
            popup.style.width = '400px';
            
            // Center popup on screen
            popup.style.top = '50%';
            popup.style.left = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            
            // Create popup content
            popup.innerHTML = `
                <div class="note-popup-header">
                    <h3>Note</h3>
                    <button class="note-popup-close">&times;</button>
                </div>
                <div style="color: #f0f0f0; white-space: pre-wrap; max-height: 200px; overflow-y: auto; padding: 10px; background: #333; border-radius: 5px;">
                    ${noteText}
                </div>
                <div class="note-popup-buttons">
                    <button class="note-popup-btn note-popup-cancel">Close</button>
                </div>
            `;
            
            // Add to document
            document.body.appendChild(popup);
            
            // Add event listeners
            popup.querySelector('.note-popup-close').addEventListener('click', () => {
                popup.remove();
            });
            
            popup.querySelector('.note-popup-cancel').addEventListener('click', () => {
                popup.remove();
            });
        }

        // Initialize highlighter
        function initHighlighter() {
            // Add click handlers to highlighter tools
            document.querySelectorAll('.highlighter-tool').forEach(tool => {
                tool.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    setHighlightColor(color);
                    
                    // If it's the erase tool, apply immediately
                    if (color === 'erase') {
                        applyHighlight(color);
                    }
                });
            });
            
            // Add mouseup event to detect text selection
            document.getElementById('passage-content').addEventListener('mouseup', function() {
                if (isHighlightingEnabled && currentHighlightColor && currentHighlightColor !== 'erase') {
                    // Small delay to ensure selection is complete
                    setTimeout(() => {
                        applyHighlight(currentHighlightColor);
                    }, 100);
                }
            });
            
            // Add click event for note elements to view/edit notes
            document.getElementById('passage-content').addEventListener('click', function(e) {
                if (e.target.classList.contains('highlight-note')) {
                    const noteText = e.target.dataset.note ? decodeURIComponent(e.target.dataset.note) : '';
                    showNotePopup(e.target, noteText);
                    e.stopPropagation();
                }
            });
            
            // Add keyboard shortcut (Ctrl+H) to toggle highlighter
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'h') {
                    e.preventDefault();
                    toggleHighlighterToolbar();
                }
            });
        }
        
        // Initialize highlighter when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initHighlighter();
            // Load saved highlights
            setTimeout(loadHighlights, 100);
            
            // Add event listeners for notes sidebar
            document.getElementById('close-notes-sidebar').addEventListener('click', toggleNotesSidebar);
            document.getElementById('clear-all-notes').addEventListener('click', clearAllNotes);
        });

        // Save highlights to localStorage
        function saveHighlights() {
            const passageContent = document.getElementById('passage-content');
            const passageTitle = document.getElementById('passage-title').textContent;
            const highlightsData = passageContent.innerHTML;
            
            // Save to localStorage
            localStorage.setItem(`highlights_${passageTitle}`, highlightsData);
        }
        
        // Load highlights from localStorage
        function loadHighlights() {
            const passageTitle = document.getElementById('passage-title').textContent;
            const savedHighlights = localStorage.getItem(`highlights_${passageTitle}`);
            
            if (savedHighlights) {
                const passageContent = document.getElementById('passage-content');
                passageContent.innerHTML = savedHighlights;
            }
            
            // Refresh notes list
            setTimeout(refreshNotesList, 100);
        }
        
        // Modified loadRandomTest function to load highlights after loading a new test
        const originalLoadRandomTest = loadRandomTest;
        loadRandomTest = function() {
            originalLoadRandomTest();
            // Small delay to ensure content is loaded before trying to load highlights
            setTimeout(loadHighlights, 100);
        };
        
        // Save highlights when applying/changing highlights
        const originalApplyHighlight = applyHighlight;
        applyHighlight = function(color) {
            originalApplyHighlight(color);
            // Small delay to ensure DOM is updated
            setTimeout(saveHighlights, 50);
        };
        
        // Show note popup for editing
        function showNotePopup(noteElement, existingNote) {
            // Remove any existing note popups
            const existingPopup = document.querySelector('.note-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // Create popup element
            const popup = document.createElement('div');
            popup.className = 'note-popup';
            
            // Position popup near the note element
            const rect = noteElement.getBoundingClientRect();
            popup.style.top = (rect.bottom + window.scrollY + 10) + 'px';
            popup.style.left = (rect.left + window.scrollX) + 'px';
            
            // Create popup content
            popup.innerHTML = `
                <div class="note-popup-header">
                    <h3>Add Note</h3>
                    <button class="note-popup-close">&times;</button>
                </div>
                <textarea placeholder="Enter your note here...">${existingNote}</textarea>
                <div class="note-popup-buttons">
                    <button class="note-popup-btn note-popup-save">Save</button>
                    <button class="note-popup-btn note-popup-cancel">Cancel</button>
                </div>
            `;
            
            // Add to document
            document.body.appendChild(popup);
            
            // Focus the textarea
            const textarea = popup.querySelector('textarea');
            textarea.focus();
            
            // Add event listeners
            popup.querySelector('.note-popup-close').addEventListener('click', () => {
                popup.remove();
            });
            
            popup.querySelector('.note-popup-cancel').addEventListener('click', () => {
                popup.remove();
            });
            
            popup.querySelector('.note-popup-save').addEventListener('click', () => {
                saveNote(noteElement, textarea.value);
                popup.remove();
            });
            
            // Close popup when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closePopup(e) {
                    if (!popup.contains(e.target) && e.target !== noteElement) {
                        popup.remove();
                        document.removeEventListener('click', closePopup);
                    }
                });
            }, 100);
        }
        
        // Save note to the element
        function saveNote(noteElement, noteText) {
            if (noteText.trim() === '') {
                // If note is empty, convert back to regular text
                const textNode = document.createTextNode(noteElement.textContent);
                noteElement.parentNode.replaceChild(textNode, noteElement);
                showHighlightNotification('Note removed (empty note)');
            } else {
                // Save note text to data attribute
                noteElement.dataset.note = encodeURIComponent(noteText);
                showHighlightNotification('Note saved!');
            }
            
            // Save highlights including notes
            setTimeout(saveHighlights, 50);
            
            // Refresh notes list
            setTimeout(refreshNotesList, 100);
        }

    </script>
</body>
</html>